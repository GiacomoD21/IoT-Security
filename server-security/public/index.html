<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="IoT Security System">
  <meta name="author" content="Norman Chen (nyc7), Giacomo DiLiberto (gvd8), Ram Vellanki (rsv32)">

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue_grey-red.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <title>IoT Security</title>

</head>

<body style="font-family: 'Roboto', sans-serif">

  <div class="mdl-card mdl-shadow--4dp" style="margin: 50px auto; width: 20%; padding: 10px">
    <div class="mdl-card__title">
      <h2 class="mdl-card__title-text">IoT Security</h2>
    </div>
    <div class="mdl-card__actions">
      <div style="display: flex; justify-content: center">
        <button id="arm" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect" style="-webkit-transition: background-color 0.6s ease-in-out 0s; -moz-transition: background-color 0.6s ease-in-out 0s; -o-transition: background-color 0.6s ease-in-out 0s; transition: background-color 0.6s ease-in-out 0s">Arm</button>
      </div>
      <div style="display: flex; justify-content: center; margin-top: 10px">
        <button id="alarm" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect" style="-webkit-transition: background-color 0.6s ease-in-out 0s; -moz-transition: background-color 0.6s ease-in-out 0s; -o-transition: background-color 0.6s ease-in-out 0s; transition: background-color 0.6s ease-in-out 0s">Sound Alarm</button>
      </div>
    </div>
  </div>

  <div style="position: relative; margin: auto; width: 80%; margin-bottom: 50px">
    <canvas id="chart"></canvas>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
  <script type="text/javascript">
    var chartElement = document.getElementById('chart');

    var chart = new Chart(chartElement.getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '# of Motion Detects',
          data: [],
          backgroundColor: [ 'rgba(96, 125, 139, 0.2)' ],
          borderColor: [ 'rgba(96, 125, 139, 1)' ],
          borderWidth: 1
        }],
      },
      options: {
        responsive: true,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 1
            },
            scaleLabel: {
              display: true,
              fontSize: 20,
              labelString: '# of Motion Detects'
            }
          }],
          xAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 1
            },
            scaleLabel: {
              display: true,
              fontSize: 20,
              labelString: 'Time (s)'
            }
          }]
        }
      }
    });

    // TODO allow for different time scales
    // TODO synchronize starting time with server

    var dataIndex = 0;

    function updateData() {
      if (!chart.data.datasets[0].data[dataIndex]) {
        chart.data.labels[dataIndex] = dataIndex;
        chart.data.datasets[0].data[dataIndex] = 0;
        chart.update();
      }
      dataIndex++;
      setTimeout(updateData, 1000);
    }
    updateData();

    new EventSource('http://api.ramvellanki.com:3001/data').onmessage = function(ev) {
      if (chart.data.datasets[0].data[ev.data]) {
        chart.data.datasets[0].data[ev.data]++;
      } else {
        chart.data.datasets[0].data[ev.data] = 1;
      }
      chart.data.labels[ev.data] = ev.data;
      chart.update();
    }

    var armElement = document.getElementById('arm');
    var alarmElement = document.getElementById('alarm');

    var armed = false;
    var alarmed = false;

    armElement.addEventListener('click', function() {
      armed = !armed;
      $.get('http://api.ramvellanki.com:3001/' + (armed ? 'arm' : 'disarm'));
      armElement.className = 'mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect ' + (armed ? 'mdl-button--accent' : 'mdl-button--colored');
      armElement.innerHTML = armed ? 'Disarm' : 'Arm';
    });
    alarmElement.addEventListener('click', function() {
      alarmed = !alarmed;
      $.get('http://api.ramvellanki.com:3001/' + (alarmed ? 'sound' : 'disarm'));
      alarmElement.className = 'mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect ' + (alarmed ? 'mdl-button--accent' : 'mdl-button--colored');
      alarmElement.innerHTML = alarmed ? 'Stop Alarm' : 'Sound Alarm';
    });
  </script>

</body>

</html>
